<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>éšæœºç›¸å†Œ Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 10px 16px;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }
    #fileInput {
      display: none;
    }
    .btn {
      border: 1px solid #555;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      background: #111;
      color: #fff;
    }
    .btn:hover {
      background: #222;
    }

    main {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    #viewer {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none; /* æ‰‹æœºä¸Šæ–¹ä¾¿æˆ‘ä»¬å¤„ç†æ»‘åŠ¨ */
      position: relative;
    }
    #viewer img,
    #viewer video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #statusText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #aaa;
      text-align: center;
      padding: 16px;
      line-height: 1.6;
    }
    #infoBar {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
    }
    #favoriteBadge {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255, 215, 0, 0.9);
      color: #000;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      display: none;
    }

    .nav-buttons {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.9);
    }
    .nav-buttons .btn {
      font-size: 12px;
      padding: 4px 10px;
    }

    footer {
      padding: 6px 16px 10px;
      font-size: 11px;
      color: #aaa;
      background: rgba(0,0,0,0.95);
      text-align: center;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <header>
    <div>éšæœºç›¸å†Œ Demo</div>
    <div>
      <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©ç…§ç‰‡/è§†é¢‘</button>
      <input id="fileInput" type="file" accept="image/*,video/*" multiple />
    </div>
  </header>

  <main>
    <div id="viewer">
      <div id="statusText">
        è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•ç…§ç‰‡æˆ–è§†é¢‘<br />
        ç‚¹å³ä¸Šè§’æŒ‰é’®ï¼Œé€‰æ‹©å‡ å¼ è¯•è¯•
      </div>
      <img id="imageElement" style="display:none" draggable="false" />
      <video id="videoElement" style="display:none" controls></video>
      <div id="favoriteBadge">å·²æ”¶è—</div>
      <div id="infoBar"></div>
    </div>
  </main>

  <div class="nav-buttons">
    <button class="btn" onclick="prev()">â¬… ä¸Šä¸€å¼ </button>
    <button class="btn" onclick="randomOne()">ğŸ² éšæœºä¸€å¼ </button>
    <button class="btn" onclick="next()">ä¸‹ä¸€å¼  â¡</button>
    <button class="btn" onclick="toggleFavorite()">â­ æ”¶è—/å–æ¶ˆ</button>
    <button class="btn" onclick="deleteCurrent()">ğŸ—‘ ä»åˆ—è¡¨ç§»é™¤</button>
  </div>

  <footer>
    é¼ æ ‡æ“ä½œï¼šç”¨ä¸Šé¢æŒ‰é’®å³å¯ã€‚<br/>
    æ‰‹æœºä¸Šï¼šä¸Šåˆ’=åˆ é™¤ Â· ä¸‹æ»‘=æ”¶è— Â· å·¦å³åˆ’=åˆ‡æ¢ Â· è½»ç‚¹=éšæœºä¸€å¼ ã€‚
  </footer>

  <script>
    // åç«¯æ¥å£åœ°å€
    const API_BASE = 'https://random-backend-zr9k.onrender.com';

  
    // åª’ä½“åˆ—è¡¨ï¼ˆåªå­˜åœ¨æµè§ˆå™¨å†…å­˜ï¼Œä¸åŠ¨çœŸæ­£ç›¸å†Œï¼‰
    let mediaList = []; // { url, type, name, favorite }
    let currentIndex = -1;

    const fileInput = document.getElementById('fileInput');
    const viewer = document.getElementById('viewer');
    const imgEl = document.getElementById('imageElement');
    const videoEl = document.getElementById('videoElement');
    const statusText = document.getElementById('statusText');
    const infoBar = document.getElementById('infoBar');
    const favoriteBadge = document.getElementById('favoriteBadge');

    fileInput.addEventListener('change', async (event) => {
      const files = Array.from(event.target.files || []);
      if (files.length === 0) return;

      // æ¸…ç†æ—§ URL
      mediaList.forEach(m => URL.revokeObjectURL(m.url));

      mediaList = files.map(file => {
        const url = URL.createObjectURL(file);
        const type = file.type.startsWith('video') ? 'video' : 'image';
        return { url, type, name: file.name, favorite: false };
      });

      // æ‰“ä¹±é¡ºåº
      shuffle(mediaList);
      currentIndex = 0;
      showCurrent();

      //é€‰å®Œä»¥åï¼Œè‡ªåŠ¨å…¨éƒ¨ä¸Šä¼ åˆ°åå°
  try {
    await uploadAll();
    alert('æˆåŠŸ');
  } catch (e) {
    console.error(e);
    alert('ä¸Šä¼ å‡ºé”™ï¼š' + (e.message || 'æœªçŸ¥é”™è¯¯'));
  }
    });

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function showCurrent() {
      if (mediaList.length === 0 || currentIndex < 0 || currentIndex >= mediaList.length) {
        imgEl.style.display = 'none';
        videoEl.style.display = 'none';
        statusText.style.display = 'block';
        statusText.textContent = 'æ²¡æœ‰å¯æ˜¾ç¤ºçš„åª’ä½“ï¼Œè¯·é‡æ–°é€‰æ‹©æ–‡ä»¶';
        infoBar.textContent = '';
        favoriteBadge.style.display = 'none';
        return;
      }

      const item = mediaList[currentIndex];

      statusText.style.display = 'none';

      if (item.type === 'image') {
        imgEl.src = item.url;
        imgEl.style.display = 'block';
        videoEl.style.display = 'none';
      } else {
        videoEl.src = item.url;
        videoEl.style.display = 'block';
        imgEl.style.display = 'none';
      }

      infoBar.textContent = `${currentIndex + 1} / ${mediaList.length} Â· ${item.name}`;
      favoriteBadge.style.display = item.favorite ? 'block' : 'none';
    }

    function next() {
      if (mediaList.length === 0) return;
      currentIndex = (currentIndex + 1) % mediaList.length;
      showCurrent();
    }

    function prev() {
      if (mediaList.length === 0) return;
      currentIndex = (currentIndex - 1 + mediaList.length) % mediaList.length;
      showCurrent();
    }

    function randomOne() {
      if (mediaList.length === 0) return;
      currentIndex = Math.floor(Math.random() * mediaList.length);
      showCurrent();
    }

    function deleteCurrent() {
      if (mediaList.length === 0) return;
      mediaList.splice(currentIndex, 1);
      if (mediaList.length === 0) {
        currentIndex = -1;
        showCurrent();
        return;
      }
      currentIndex = Math.min(currentIndex, mediaList.length - 1);
      showCurrent();
    }
    // æŠŠä¸€ä¸ªåª’ä½“é¡¹ä¸Šä¼ åˆ°åå°

async function uploadItem(item) {
  if (!item) return;

  // ä»æœ¬åœ° blob URL è¯»æˆ Blob
  const response = await fetch(item.url);
  const blob = await response.blob();

  const formData = new FormData();
  formData.append('file', blob, item.name || 'image.jpg');

  let res;
  try {
    res = await fetch(API_BASE + '/upload', {
      method: 'POST',
      body: formData,
    });
  } catch (e) {
    console.error('ç½‘ç»œé”™è¯¯:', e);
    throw new Error('ç½‘ç»œé”™è¯¯ï¼š' + e.message);
  }

  if (!res.ok) {
    const text = await res.text().catch(() => '');
    console.error('æœåŠ¡ç«¯é”™è¯¯:', res.status, text);
    throw new Error('æœåŠ¡ç«¯é”™è¯¯ï¼š' + res.status + ' ' + text.slice(0, 80));
  }

  const data = await res.json().catch(() => ({}));
  console.log('ä¸Šä¼ æˆåŠŸ:', data);
}


// ä¸Šä¼ å½“å‰è¿™å¼ 
async function uploadCurrent() {
  if (mediaList.length === 0) {
    alert('è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•å›¾ç‰‡');
    return;
  }
  const item = mediaList[currentIndex];
  await uploadItem(item);
  alert('å½“å‰å›¾ç‰‡ä¸Šä¼ å®Œæˆ');
}

// ä¸Šä¼ å…¨éƒ¨
async function uploadAll() {
  if (mediaList.length === 0) {
    alert('è¿˜æ²¡æœ‰é€‰æ‹©ä»»ä½•å›¾ç‰‡');
    return;
  }
  for (const item of mediaList) {
    await uploadItem(item);
  }
  alert('å…¨éƒ¨å›¾ç‰‡ä¸Šä¼ å®Œæˆ');
}

    function toggleFavorite() {
      if (mediaList.length === 0) return;
      const item = mediaList[currentIndex];
      item.favorite = !item.favorite;
      favoriteBadge.style.display = item.favorite ? 'block' : 'none';
    }
    // ===== æ‰‹åŠ¿ï¼šæ‰‹æœº / è§¦æ‘¸æ¿æ»‘åŠ¨ =====
    let startX = 0;
    let startY = 0;
    let startTime = 0;

    function handleStart(x, y) {
      startX = x;
      startY = y;
      startTime = Date.now();
    }

    function handleEnd(x, y) {
      const dx = x - startX;
      const dy = y - startY;
      const dt = Date.now() - startTime;

      const absX = Math.abs(dx);
      const absY = Math.abs(dy);

      const tapThreshold = 200;   // ç‚¹å‡»æ—¶é—´
      const moveThreshold = 10;   // ç‚¹å‡»å…è®¸çš„ç§»åŠ¨èŒƒå›´
      const swipeThreshold = 40;  // è®¤ä¸ºæ˜¯æ»‘åŠ¨çš„è·ç¦»

      // è½»ç‚¹ï¼šéšæœºä¸€å¼ 
      if (dt < tapThreshold && absX < moveThreshold && absY < moveThreshold) {
        randomOne();
        return;
      }

      if (absX > absY) {
        // å·¦å³æ»‘
        if (dx < -swipeThreshold) {
          next(); // å‘å·¦æ»‘ â†’ ä¸‹ä¸€å¼ 
        } else if (dx > swipeThreshold) {
          prev(); // å‘å³æ»‘ â†’ ä¸Šä¸€å¼ 
        }
      } else {
        // ä¸Šä¸‹æ»‘
        if (dy < -swipeThreshold) {
          deleteCurrent(); // å‘ä¸Š â†’ åˆ é™¤
        } else if (dy > swipeThreshold) {
          toggleFavorite(); // å‘ä¸‹ â†’ æ”¶è—
        }
      }
    }

    // è§¦æ‘¸äº‹ä»¶ï¼ˆæ‰‹æœºï¼‰
    viewer.addEventListener('touchstart', (e) => {
      const t = e.touches[0];
      handleStart(t.clientX, t.clientY);
    });

    viewer.addEventListener('touchend', (e) => {
      const t = e.changedTouches[0];
      handleEnd(t.clientX, t.clientY);
    });

    // é¼ æ ‡äº‹ä»¶ï¼ˆç”µè„‘ä¸Šä¹Ÿå¯ä»¥æ‹–åŠ¨ï¼‰
    let isMouseDown = false;

    viewer.addEventListener('mousedown', (e) => {
      isMouseDown = true;
      handleStart(e.clientX, e.clientY);
    });

    viewer.addEventListener('mouseup', (e) => {
      if (!isMouseDown) return;
      isMouseDown = false;
      handleEnd(e.clientX, e.clientY);
    });
  </script>
</body>
</html>
